name: Docker E2E Tests

on:
  workflow_dispatch: # Manual trigger
  push:
    branches: [main] # Trigger on merge to main

env:
  IMAGE_NAME: looplia:test

jobs:
  # Build Docker image once and share with all test jobs
  build:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Bun
        uses: oven-sh/setup-bun@v2
        with:
          bun-version: latest

      - name: Install dependencies
        run: bun install --frozen-lockfile

      - name: Build project
        run: bun run build

      - name: Build Docker image
        run: docker build -t $IMAGE_NAME .

      - name: Save Docker image
        run: docker save $IMAGE_NAME | gzip > looplia-image.tar.gz

      - name: Upload Docker image
        uses: actions/upload-artifact@v4
        with:
          name: docker-image
          path: looplia-image.tar.gz
          retention-days: 1

  # Test: Markdown file with full pipeline
  test-markdown:
    runs-on: ubuntu-latest
    needs: build
    timeout-minutes: 30

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Download Docker image
        uses: actions/download-artifact@v4
        with:
          name: docker-image

      - name: Load Docker image
        run: gunzip -c looplia-image.tar.gz | docker load

      - name: Create test workspace
        run: mkdir -p test-workspace

      - name: Run pipeline command
        env:
          CLAUDE_CODE_OAUTH_TOKEN: ${{ secrets.CLAUDE_CODE_OAUTH_TOKEN }}
        run: |
          CONTAINER_ID=$(docker create \
            -e CLAUDE_CODE_OAUTH_TOKEN="$CLAUDE_CODE_OAUTH_TOKEN" \
            -v "$(pwd)/examples:/examples:ro" \
            $IMAGE_NAME \
            run --file /examples/ai-healthcare.md \
            --topics "ai,healthcare,technology" \
            --tone "expert")

          # Run container and capture exit code
          docker start -a "$CONTAINER_ID" || EXIT_CODE=$?

          # Always copy files for debugging (even on failure)
          docker cp "$CONTAINER_ID:/home/looplia/.looplia/." test-workspace/ || true
          docker rm "$CONTAINER_ID"

          # Exit with original code
          exit ${EXIT_CODE:-0}

      - name: Debug - List workspace contents
        if: always()
        run: |
          echo "=== Workspace Structure ==="
          find test-workspace -type f 2>/dev/null | head -50 || echo "No files found"
          echo ""
          echo "=== Session folder contents ==="
          SESSION_DIR=$(find test-workspace/contentItem -maxdepth 1 -type d ! -name contentItem 2>/dev/null | head -1)
          if [ -n "$SESSION_DIR" ]; then
            echo "Session: $SESSION_DIR"
            ls -la "$SESSION_DIR" || true
            echo ""
            echo "=== content.md (first 20 lines) ==="
            head -20 "$SESSION_DIR/content.md" 2>/dev/null || echo "No content.md"
            echo ""
            echo "=== session.json ==="
            cat "$SESSION_DIR/session.json" 2>/dev/null || echo "No session.json"
            echo ""
            echo "=== summary.json (if exists) ==="
            cat "$SESSION_DIR/summary.json" 2>/dev/null || echo "No summary.json"
            echo ""
            echo "=== writing-kit.json (if exists) ==="
            cat "$SESSION_DIR/writing-kit.json" 2>/dev/null | head -100 || echo "No writing-kit.json"
            echo ""
            echo "=== Query logs (last 200 lines) ==="
            tail -200 "$SESSION_DIR/query.log" 2>/dev/null || echo "No query.log"
          else
            echo "No session directory found"
            echo "Contents of test-workspace:"
            ls -laR test-workspace/ 2>/dev/null || echo "Empty"
          fi

      - name: Validate session created
        run: |
          echo "Checking session was created..."
          SESSION_DIR=$(find test-workspace/contentItem -maxdepth 1 -type d ! -name contentItem | head -1)
          [ -n "$SESSION_DIR" ] || (echo "ERROR: No session directory found" && exit 1)
          echo "Session folder: $SESSION_DIR"

          # Check content.md exists
          [ -f "$SESSION_DIR/content.md" ] || (echo "ERROR: content.md not found" && exit 1)
          echo "✓ content.md exists"

      - name: Validate writing-kit output
        run: |
          SESSION_DIR=$(find test-workspace/contentItem -maxdepth 1 -type d ! -name contentItem | head -1)

          # Check writing-kit.json exists
          [ -f "$SESSION_DIR/writing-kit.json" ] || (echo "ERROR: writing-kit.json not found" && exit 1)
          echo "✓ writing-kit.json exists"

          # Validate basic structure
          jq -e '.contentId' "$SESSION_DIR/writing-kit.json" > /dev/null || (echo "ERROR: missing contentId" && exit 1)
          jq -e '.summary' "$SESSION_DIR/writing-kit.json" > /dev/null || (echo "ERROR: missing summary" && exit 1)
          jq -e '.ideas' "$SESSION_DIR/writing-kit.json" > /dev/null || (echo "ERROR: missing ideas" && exit 1)
          jq -e '.suggestedOutline' "$SESSION_DIR/writing-kit.json" > /dev/null || (echo "ERROR: missing suggestedOutline" && exit 1)
          echo "✓ writing-kit.json has valid structure"

      - name: Upload test artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: test-results-markdown
          path: test-workspace/
          retention-days: 7

  # Commented out for now - focus on markdown test first
  # test-vtt:
  #   ...

  # test-srt:
  #   ...

  # semantic-evaluation:
  #   ...
